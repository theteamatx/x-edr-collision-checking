// Copyright 2023 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include "collision_checking/assembly_kinematics.h"

#include <string>
#include <vector>

#include "collision_checking/assembly/assembly.h"
#include "collision_checking/assembly/assembly.pb.h"
#include "collision_checking/assembly/proto_utils.h"
#include "collision_checking/assembly_coordinates.h"
#include "collision_checking/eigenmath.h"
#include "collision_checking/test_utils.h"
#include "eigenmath/matchers.h"
#include "gtest/gtest.h"

namespace collision_checking {
namespace {
using ::collision_checking::testing::ParseTextProtoOrDie;
using ::eigenmath::testing::IsApprox;

// Golden test data, validated against a different kinematics implementation.
// Layout is: quat.w, quat.x, quat.y, quat.z, trans.x, trans.y, trans.z,
// joint[0], joint[1].
template <typename Scalar>
struct InputTestData {
  Scalar values[9];
};
template <typename Scalar>
std::vector<InputTestData<Scalar>> GetInputTestData();
template <>
std::vector<InputTestData<double>> GetInputTestData() {
  return {
      {3.69974081261311039e-01, -8.43778746322839668e-01,
       3.40448033704709774e-01, 1.87754474767721002e-01,
       -6.27741212255572556e-03, -7.94170475746939664e-01,
       -7.02454539885096763e-01, 4.50528633468994452e-02,
       6.12132147080535538e-01},
      {1.01969573924383258e-01, 1.97875451823474519e-01,
       -9.74453282436432588e-01, -2.98045618689115055e-02,
       1.89657151246915401e-01, -4.98779120047693980e-01,
       -7.05264526701089967e-01, 5.55778534353396081e-01,
       6.49721678397857771e-01},
      {-6.64823503897746027e-01, -4.04780536838752703e-01,
       -4.27956824049031181e-01, 4.59364106577257125e-01,
       1.61754464919208196e-01, -6.62236334608822919e-01,
       -1.68262466752593043e-01, 8.73765931554459252e-01,
       5.55064804142920365e-01},
      {-2.19576670520071460e-01, -8.54750758938039756e-01,
       2.68799769374512276e-01, 3.85919563953907474e-01,
       -1.42177518715263185e-01, -7.20615347535477624e-01,
       -5.39521407297579580e-01, 4.21095944243746245e-01,
       4.44821385327540897e-01},
      {2.61524471124866875e-01, -8.07614434649618768e-02,
       3.45217001727031958e-01, -8.97723655681921251e-01,
       6.49535370280778235e-01, -6.74691339192738049e-01,
       -2.06611524811850744e-01, 1.18452218851078983e-01,
       9.37555052847814374e-01},
      {4.68452014984236553e-01, -4.03794852001626015e-01,
       7.56595220489395759e-01, -2.12287775170394988e-01,
       -6.93083236481510045e-01, -5.41223797891507985e-02,
       2.17995824229445745e-01, 1.34821733435789876e-01,
       8.04510792067016367e-01},
      {-5.42050752611374920e-01, -6.20240178779829288e-01,
       1.02303879885124252e-01, 5.57688997902108019e-01,
       8.33737889027411638e-01, 6.48677293181292303e-02,
       -3.84086867917456165e-01, 5.65225664695489183e-01,
       5.07201436905183115e-02},
      {7.25719653356499017e-01, -3.88297062918424474e-01,
       1.58322864000979918e-01, -5.45426664543983586e-01,
       -1.26920999181389216e-01, 5.51730348125433423e-01,
       -9.99276742520947114e-01, 5.16908598084873216e-01,
       7.96319859402797370e-01},
      {-7.29159508359214156e-03, -2.37821782652107377e-01,
       9.43858864817248233e-01, -2.29168225640480727e-01,
       -1.94054283827560514e-01, 8.39008500939056656e-01,
       3.94072612349166684e-01, 4.33222329148115592e-01,
       9.92871424938864822e-01},
      {5.15422616861882954e-01, -8.31101833759850472e-01,
       2.76799736702796027e-02, -2.06985716912725853e-01,
       1.60016191074517922e-01, 8.03619753439047679e-01,
       8.60045729063107167e-01, 1.33030937495565410e-01,
       9.15544619131502646e-01},
      {-2.73328002827191774e-01, -1.57475153476298785e-01,
       2.03540721644310252e-01, 9.26857353394052841e-01,
       -4.67565346232406198e-01, -1.51150572595461941e-01,
       4.36773025424677108e-02, 9.06418752405727446e-01,
       6.39502986466890300e-01},
      {2.60366245534112584e-01, -8.63103503447101628e-01,
       4.10834938255180471e-01, -1.35927973694421250e-01,
       8.46211367289108729e-01, -4.74346833484583730e-01,
       5.90533564272421208e-01, 4.94399156231599135e-01,
       6.67125501072657889e-01},
      {1.98116506282550037e-01, 8.30695883990659634e-01,
       3.09956220187143972e-01, 4.17877182706440198e-01,
       5.75633807507807127e-02, -4.37225066472288981e-01,
       3.60163630658440592e-01, 3.26523626699276370e-01,
       9.13063946252602010e-01},
      {1.45486652467575923e-02, 9.72784615014944065e-01,
       -2.00779010358250964e-01, -1.14744142026189072e-01,
       -8.60239069558661584e-01, 5.59744534415890893e-01,
       -2.28001013891047655e-01, 6.77285805699099214e-02,
       8.62565077572338690e-01},
      {-7.52693465859557209e-01, 5.03788028971853596e-01,
       3.70932465145253798e-01, 2.05083579591949533e-01,
       2.31820758861717602e-01, -8.16282505034648942e-02,
       3.36606215403507436e-01, 4.26894368251014122e-01,
       6.38844500092850098e-01},
      {-6.91360217516071240e-01, -5.56369244301818000e-01,
       -4.57593225960513494e-01, 5.55225466473334706e-02,
       -9.08524475691667499e-01, -5.16195579802288584e-01,
       6.92693304151742240e-01, 5.75699624598318582e-01,
       4.18971729162376294e-01},
      {-2.58627410041486205e-01, -1.35296070919016298e-01,
       2.87135009443985234e-01, 9.12337833437105727e-01,
       1.56747011660451685e-01, 9.55395164955757714e-01,
       5.53785534603690621e-01, 1.30410253671962018e-01,
       2.30589710345632415e-01},
      {-6.08999141799323573e-01, -3.79844859053663109e-01,
       -6.56717538808806789e-01, 2.31430340619145358e-01,
       3.98104690444645026e-02, -4.65483297350445024e-01,
       6.58144688147516810e-01, 7.23038226712240384e-01,
       3.36150779032193592e-01},
      {-1.81751043909459592e-01, 2.15556056782916450e-01,
       2.67624683819621179e-01, 9.21346391447033120e-01,
       2.02492311681404136e-01, 5.49625216084595802e-01,
       -9.48454302033222785e-01, 7.79888275740186376e-01,
       9.61657855043912435e-01},
      {-9.26899667237793684e-02, -8.24711941919291647e-01,
       1.24767432552716981e-01, -5.43775570156161847e-01,
       8.76016432804421097e-01, 5.80071929854323320e-01,
       9.14407532663196188e-01, 5.42357735680300990e-01,
       2.27083212034575987e-01},
  };
}
template <>
std::vector<InputTestData<float>> GetInputTestData() {
  return {
      {1.90559163689613342e-01, 7.04096019268035889e-01,
       6.33509397506713867e-01, 2.58073627948760986e-01,
       -7.69890904426574707e-01, -6.27744197845458984e-03,
       2.18133091926574707e-01, 2.40589618682861328e-01,
       1.72132566571235657e-01},
      {2.62508064508438110e-01, -8.31285595893859863e-01,
       -4.83965903520584106e-01, 7.63602107763290405e-02,
       -3.45721900463104248e-01, 6.22072815895080566e-01,
       7.18274950981140137e-01, 5.41162192821502686e-01,
       6.12132132053375244e-01},
      {3.00909012556076050e-01, 5.30791759490966797e-01,
       -6.83849215507507324e-01, 4.00080263614654541e-01,
       -9.41972374916076660e-01, 1.89657092094421387e-01,
       4.67496633529663086e-01, 8.02047133445739746e-01,
       1.12861059606075287e-02},
      {-9.17712748050689697e-01, -1.58113017678260803e-01,
       1.42333179712295532e-01, -3.35477143526077271e-01,
       -4.91157770156860352e-01, -6.37698769569396973e-02,
       -8.86230111122131348e-01, 2.21028998494148254e-01,
       6.49721682071685791e-01},
      {-3.54860603809356689e-01, 4.22346830368041992e-01,
       8.07924091815948486e-01, 2.07257792353630066e-01,
       -1.90021097660064697e-01, 1.61754488945007324e-01,
       -3.67807030677795410e-01, 8.43224704265594482e-01,
       6.53005659580230713e-01},
      {4.45818901062011719e-01, 5.09264945983886719e-01,
       -5.80412924289703369e-01, -4.52786415815353394e-01,
       6.97878241539001465e-01, 2.41143226623535156e-01,
       9.42930221557617188e-01, 9.54488098621368408e-01,
       5.55064797401428223e-01},
      {4.62862513959407806e-02, 4.59551930427551270e-01,
       8.05679678916931152e-01, 3.70877206325531006e-01,
       -1.08483254909515381e-01, -1.42177522182464600e-01,
       3.39449286460876465e-01, 8.97098600864410400e-01,
       1.97147816419601440e-01},
      {-5.07073819637298584e-01, 2.63308696448802948e-02,
       8.16686809062957764e-01, 2.74236202239990234e-01,
       -4.03993010520935059e-01, 5.96984386444091797e-01,
       -4.75390374660491943e-01, 5.43202519416809082e-01,
       4.44821387529373169e-01},
      {-3.21286141872406006e-01, -1.24924615025520325e-01,
       9.06498551368713379e-01, 2.43781760334968567e-01,
       -4.88072633743286133e-02, 6.49535417556762695e-01,
       2.72747397422790527e-01, 9.08662736415863037e-01,
       8.74302804470062256e-01},
      {6.55921578407287598e-01, 2.75216877460479736e-01,
       3.59359711408615112e-01, 6.04055702686309814e-01,
       8.20306181907653809e-01, 9.26848888397216797e-01,
       5.05113601684570312e-02, 1.80914595723152161e-01,
       9.37555074691772461e-01},
      {-5.32635569572448730e-01, -5.44521331787109375e-01,
       4.80164259672164917e-01, -4.35015082359313965e-01,
       9.06080484390258789e-01, -6.93083226680755615e-01,
       -1.76094055175781250e-01, 6.72177255153656006e-01,
       2.64513403177261353e-01},
      {6.39338791370391846e-01, -1.57228112220764160e-01,
       2.07358464598655701e-01, 7.23552107810974121e-01,
       2.57571578025817871e-01, 8.43950867652893066e-01,
       -4.48882460594177246e-01, 2.06891372799873352e-01,
       8.04510772228240967e-01},
      {-2.59880900382995605e-01, -6.81040287017822266e-01,
       -6.12394250929355621e-02, 6.81832671165466309e-01,
       -1.91189527511596680e-01, 8.33737850189208984e-01,
       9.87144947052001953e-01, 4.45061415433883667e-01,
       6.04836046695709229e-01},
      {-5.59964954853057861e-01, -7.83735156059265137e-01,
       -1.14115387201309204e-01, -2.43261694908142090e-01,
       1.21326327323913574e-01, 5.52034258842468262e-01,
       -1.77489042282104492e-01, 3.99196892976760864e-01,
       5.07201440632343292e-02},
      {8.80829811096191406e-01, -3.00765067338943481e-01,
       -3.65616172552108765e-01, 2.00140709057450294e-03,
       3.40290307998657227e-01, -1.26920998096466064e-01,
       4.09431219100952148e-01, 5.40034472942352295e-01,
       8.24159264564514160e-01},
      {-9.41983640193939209e-01, -3.07139545679092407e-01,
       9.07806679606437683e-02, -1.00454449653625488e-01,
       -5.87836265563964844e-01, 6.23236179351806641e-01,
       -6.01677060127258301e-01, 2.90332764387130737e-01,
       7.96319842338562012e-01},
      {-3.13248455524444580e-01, 2.23609909415245056e-01,
       1.74626424908638000e-01, -9.06300008296966553e-01,
       3.11925649642944336e-01, -1.94054305553436279e-01,
       -4.00766432285308838e-01, 4.03956681489944458e-01,
       5.25712445378303528e-02},
      {-7.88233995437622070e-01, -2.65513598918914795e-01,
       -4.29609984159469604e-01, 3.51603418588638306e-01,
       -3.79460930824279785e-01, 9.21431660652160645e-01,
       -5.13203978538513184e-01, 2.45343253016471863e-01,
       9.92871403694152832e-01},
      {8.59315037727355957e-01, -2.95001477003097534e-01,
       -1.05661123991012573e-01, -4.04212355613708496e-01,
       4.95541214942932129e-01, 1.60016179084777832e-01,
       4.40293312072753906e-01, 1.02742783725261688e-01,
       3.08503568172454834e-01},
      {6.49845361709594727e-01, -1.45315051078796387e-01,
       1.99148982763290405e-01, 7.18974530696868896e-01,
       8.87284874916076660e-01, 5.10597467422485352e-01,
       6.67929649353027344e-03, 1.98579877614974976e-01,
       9.15544629096984863e-01},
  };
}
template <typename Scalar>
struct OutputTestData {
  // values[link] = {rot00, rot01 rot02,..., trans.x, trans.y, trans.z};
  Scalar values[4][12];
};
template <typename Scalar>
std::vector<OutputTestData<Scalar>> GetOutputTestData();
template <>
std::vector<OutputTestData<double>> GetOutputTestData() {
  return {{{
              {6.97686787102588024e-01, -7.13454208744646934e-01,
               -6.49325736977819923e-02, -4.35597051525096646e-01,
               -4.94428631082891590e-01, 7.52193816425089201e-01,
               -5.68760367646261367e-01, -4.96511249409364641e-01,
               -6.55734872799092594e-01, -6.27741212255572556e-03,
               -7.94170475746939664e-01, -7.02454539885096763e-01},
              {7.29111120579169159e-01, 6.81308105573954270e-01,
               6.49325736977819923e-02, -4.12887156766682528e-01,
               5.13545186238742457e-01, -7.52193816425089201e-01,
               -5.45821554745608450e-01, 5.21623050650798503e-01,
               6.55734872799092594e-01, 6.91409374980032299e-01,
               -1.22976752727203631e+00, -1.27121490753135813e+00},
              {7.29111120579169159e-01, -6.81308105573954270e-01,
               -6.49325736977819923e-02, -4.12887156766682528e-01,
               -5.13545186238742457e-01, 7.52193816425089201e-01,
               -5.45821554745608450e-01, -5.21623050650798503e-01,
               -6.55734872799092594e-01, 1.68477800764479890e+00,
               -1.44346701527517141e+00, -1.61471564958774039e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-9.00895023118671423e-01, -3.79562450136402219e-01,
               -2.10524354330942604e-01, -3.91719084035505483e-01,
               9.19913987314916026e-01, 1.77317552644120566e-02,
               1.86933989746096346e-01, 9.84408573145501564e-02,
               -9.77427788170964096e-01, 1.89657151246915401e-01,
               -4.98779120047693980e-01, -7.05264526701089967e-01},
              {-5.65042281393087098e-01, 7.97751036647170841e-01,
               2.10524354330942604e-01, -8.18112471966775834e-01,
               -5.74784801528062550e-01, -1.77317552644120566e-02,
               1.06860673077175727e-01, -1.82251791378604144e-01,
               9.77427788170964096e-01, -7.11237871871756022e-01,
               -8.90498204083199463e-01, -5.18330536954993648e-01},
              {-5.65042281393087098e-01, -7.97751036647170841e-01,
               -2.10524354330942604e-01, -8.18112471966775834e-01,
               5.74784801528062550e-01, 1.77317552644120566e-02,
               1.06860673077175727e-01, 1.82251791378604144e-01,
               -9.77427788170964096e-01, -9.96845259091703073e-01,
               -1.90994533161164548e+00, -4.75308715470899146e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {2.11675148676689906e-01, 9.57249295763848429e-01,
               1.97148211232863857e-01, -2.64334923834350533e-01,
               2.50274669170019060e-01, -9.31391237887347678e-01,
               -9.40914809892048454e-01, 1.45039221355653225e-01,
               3.06011347492795460e-01, 1.61754464919208196e-01,
               -6.62236334608822919e-01, -1.68262466752593043e-01},
              {-5.98089200127299159e-01, -7.76802350343232417e-01,
               -1.97148211232863857e-01, -3.61586679057854021e-01,
               4.20170859840002520e-02, 9.31391237887347678e-01,
               -7.15223309337021274e-01, 6.28341207455506146e-01,
               -3.06011347492795460e-01, 3.73429613595898102e-01,
               -9.26571258443173451e-01, -1.10917727664464150e+00},
              {-5.98089200127299159e-01, 7.76802350343232417e-01,
               1.97148211232863857e-01, -3.61586679057854021e-01,
               -4.20170859840002520e-02, -9.31391237887347678e-01,
               -7.15223309337021274e-01, -6.28341207455506146e-01,
               3.06011347492795460e-01, -5.70286292423606955e-01,
               -1.26946305711939256e+00, -1.54482946777737329e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {5.57625548283669836e-01, -2.90035747867355254e-01,
               -7.77774397148916496e-01, -6.28991479633582484e-01,
               -7.59065539495058061e-01, -1.67896471968392635e-01,
               -5.41685763565642575e-01, 5.82836831120083332e-01,
               -6.05704351841891864e-01, -1.42177518715263185e-01,
               -7.20615347535477624e-01, -5.39521407297579580e-01},
              {6.27467496094807342e-01, 3.67631402923145334e-02,
               7.77774397148916496e-01, -2.63767418309870549e-01,
               9.49861844553571366e-01, 1.67896471968392635e-01,
               -7.32605821968852933e-01, -3.10501123632645037e-01,
               6.05704351841891864e-01, 4.15448029568406652e-01,
               -1.34960682716906000e+00, -1.08120717086322227e+00},
              {6.27467496094807342e-01, -3.67631402923145334e-02,
               -7.77774397148916496e-01, -2.63767418309870549e-01,
               -9.49861844553571366e-01, -1.67896471968392635e-01,
               -7.32605821968852933e-01, 3.10501123632645037e-01,
               -6.05704351841891864e-01, 1.06332563496171040e+00,
               -1.08603126248945214e+00, -1.98619657650468895e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-8.50165080504628579e-01, 4.13792961800750370e-01,
               3.25568304130977371e-01, -5.25313855273235708e-01,
               -6.24860345442914022e-01, -5.77576750008976569e-01,
               -3.55624710689198265e-02, -6.62061125166796494e-01,
               7.48605621936108356e-01, 6.49535370280778235e-01,
               -6.74691339192738049e-01, -2.06611524811850744e-01},
              {-8.93107902967286482e-01, -3.10424794439257024e-01,
               -3.25568304130977371e-01, -4.47789711790857581e-01,
               6.82560965675102715e-01, 5.77576750008976569e-01,
               4.29260721664147110e-02, 6.61624497078226459e-01,
               -7.48605621936108356e-01, -2.00629710223850344e-01,
               -1.20000519446597376e+00, -2.42173995880770571e-01},
              {-8.93107902967286482e-01, 3.10424794439257024e-01,
               3.25568304130977371e-01, -4.47789711790857581e-01,
               -6.82560965675102715e-01, -5.77576750008976569e-01,
               4.29260721664147110e-02, -6.61624497078226459e-01,
               7.48605621936108356e-01, -1.11312207307462430e+00,
               -1.60517242282710471e+00, -1.57932816959714617e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-2.35004854308387134e-01, -4.12125238095122026e-01,
               8.80298532644768539e-01, -8.09911782235490540e-01,
               5.83767236020377500e-01, 5.70851919963500376e-02,
               -5.37415689618032211e-01, -6.99548856245343131e-01,
               -4.70973220340825005e-01, -6.93083236481510045e-01,
               -5.41223797891507985e-02, 2.17995824229445745e-01},
              {-1.77476994333442550e-01, 4.39973192258158452e-01,
               -8.80298532644768539e-01, -8.81028375886315218e-01,
               -4.69606517989115346e-01, -5.70851919963500376e-02,
               -4.38509882859541511e-01, 7.65436678214667321e-01,
               4.70973220340825005e-01, -9.28088090789897180e-01,
               -8.64034162024641339e-01, -3.19419865388586466e-01},
              {-1.77476994333442550e-01, -4.39973192258158452e-01,
               8.80298532644768539e-01, -8.81028375886315218e-01,
               4.69606517989115346e-01, 5.70851919963500376e-02,
               -4.38509882859541511e-01, -7.65436678214667321e-01,
               -4.70973220340825005e-01, -1.01955507425704606e+00,
               -1.83686554415281522e+00, -6.08295138301088611e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {3.57033795558785227e-01, 4.77685528572203033e-01,
               -8.02710037698285306e-01, -7.31497435571481613e-01,
               -3.91429795507784117e-01, -5.58295814905575338e-01,
               -5.80894457351104010e-01, 7.86510807924105548e-01,
               2.09672073575230877e-01, 8.33737889027411638e-01,
               6.48677293181292303e-02, -3.84086867917456165e-01},
              {4.56521031278856460e-02, -5.94619610220196493e-01,
               8.02710037698285306e-01, -4.08073694679613741e-01,
               7.22344545746314237e-01, 5.58295814905575338e-01,
               -9.11806857393894665e-01, -3.53052228957887682e-01,
               -2.09672073575230877e-01, 1.19077168458619687e+00,
               -6.66629706253352383e-01, -9.64981325268560175e-01},
              {4.56521031278856460e-02, 5.94619610220196493e-01,
               -8.02710037698285306e-01, -4.08073694679613741e-01,
               -7.22344545746314237e-01, -5.58295814905575338e-01,
               -9.11806857393894665e-01, 3.53052228957887682e-01,
               2.09672073575230877e-01, 6.71963369565454327e-01,
               -3.88996274340967174e-01, -2.21193355183734042e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {3.54887248677903999e-01, 6.68701093679675229e-01,
               6.53371171722041733e-01, -9.14606306017329840e-01,
               1.03470289066699861e-01, 3.90882596534800952e-01,
               1.93779115797244605e-01, -7.36296643067221868e-01,
               6.48318523326904650e-01, -1.26920999181389216e-01,
               5.51730348125433423e-01, -9.99276742520947114e-01},
              {-2.19471149939606813e-02, -7.56719522746709616e-01,
               -6.53371171722041733e-01, -8.46248484479569463e-01,
               3.62041845982261856e-01, -3.90882596534800952e-01,
               5.32336197021650692e-01, 5.44335618577131197e-01,
               -6.48318523326904650e-01, 2.27966249496514783e-01,
               -3.62875957891896417e-01, -8.05497626723702509e-01},
              {-2.19471149939606813e-02, 7.56719522746709616e-01,
               6.53371171722041733e-01, -8.46248484479569463e-01,
               -3.62041845982261856e-01, 3.90882596534800952e-01,
               5.32336197021650692e-01, -5.44335618577131197e-01,
               6.48318523326904650e-01, 5.18903957168562191e-02,
               -1.13538370827972801e+00, -1.62291074378196454e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-8.86775264674621644e-01, -4.52282399420456172e-01,
               9.52379185814664075e-02, -4.45598391790873516e-01,
               7.81845448105935037e-01, -4.36073122892728704e-01,
               1.22766865214691628e-01, -4.29136722328099851e-01,
               -8.94857513995861442e-01, -1.94054283827560514e-01,
               8.39008500939056656e-01, 3.94072612349166684e-01},
              {-6.14985885016330447e-01, 7.82765673809826090e-01,
               -9.52379185814664075e-02, -7.32649862669903507e-01,
               -5.22555652749403077e-01, 4.36073122892728704e-01,
               2.91575959160649156e-01, 3.37954863383698512e-01,
               8.94857513995861442e-01, -1.08082954850218216e+00,
               3.93410109148183140e-01, 5.16839477563858285e-01},
              {-6.14985885016330447e-01, -7.82765673809826090e-01,
               9.52379185814664075e-02, -7.32649862669903507e-01,
               5.22555652749403077e-01, -4.36073122892728704e-01,
               2.91575959160649156e-01, -3.37954863383698512e-01,
               -8.94857513995861442e-01, -1.69023542965747930e+00,
               -3.42964830715965008e-01, 8.10824573335413801e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {9.12781464103475049e-01, 1.67360485976792595e-01,
               3.72586186704134570e-01, -2.59379993479967652e-01,
               -4.67146690169722545e-01, 8.45278645681887042e-01,
               3.15518648848920447e-01, -8.68196082458959850e-01,
               -3.82992878042746954e-01, 1.60016191074517922e-01,
               8.03619753439047679e-01, 8.60045729063107167e-01},
              {8.82518005116321280e-01, -2.86952093776609907e-01,
               -3.72586186704134570e-01, -1.95126397246371985e-01,
               4.97423059630176190e-01, -8.45278645681887042e-01,
               4.27887438169385403e-01, 8.18675024429946663e-01,
               3.82992878042746954e-01, 1.07279765517799297e+00,
               5.44239759959080027e-01, 1.17556437791202750e+00},
              {8.82518005116321280e-01, 2.86952093776609907e-01,
               3.72586186704134570e-01, -1.95126397246371985e-01,
               -4.97423059630176190e-01, 8.45278645681887042e-01,
               4.27887438169385403e-01, -8.18675024429946663e-01,
               -3.82992878042746954e-01, 1.93108101192339787e+00,
               3.91123416666547818e-01, 1.67259332707717046e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-8.00986757816229522e-01, 4.42566925858557614e-01,
               -4.03180765834818544e-01, -5.70777351377015130e-01,
               -7.67725955006024030e-01, 2.91221690753157514e-01,
               -1.80647250070639781e-01, 4.63391167531486570e-01,
               8.67545501340259095e-01, -4.67565346232406198e-01,
               -1.51150572595461941e-01, 4.36773025424677108e-02},
              {-8.42297030565740124e-01, 3.57744297454181348e-01,
               4.03180765834818544e-01, 2.52507442362935597e-01,
               9.22729601988687032e-01, -2.91221690753157514e-01,
               -4.76209726750163376e-01, -1.43489021366839109e-01,
               -8.67545501340259095e-01, -1.26855210404863561e+00,
               -7.21927923972477070e-01, -1.36969947528172070e-01},
              {-8.42297030565740124e-01, -3.57744297454181348e-01,
               -4.03180765834818544e-01, 2.52507442362935597e-01,
               -9.22729601988687032e-01, 2.91221690753157514e-01,
               -4.76209726750163376e-01, 1.43489021366839109e-01,
               8.67545501340259095e-01, -1.98188338377364293e+00,
               -1.36779215794024855e-01, -6.64907037955869473e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {6.25476478952381565e-01, -6.38404036745287784e-01,
               4.48574921439721497e-01, -7.79968261440792010e-01,
               -5.26848143390664658e-01, 3.37758116039923006e-01,
               2.07047198087603190e-02, -5.61133958759520435e-01,
               -8.27466008307597978e-01, 8.46211367289108729e-01,
               -4.74346833484583730e-01, 5.90533564272421208e-01},
              {8.53502683909504567e-01, 2.65167321543624879e-01,
               -4.48574921439721497e-01, -4.36579217963183885e-01,
               8.33857326820252154e-01, -3.37758116039923006e-01,
               2.84485069910403510e-01, 4.84115946952342446e-01,
               8.27466008307597978e-01, 1.47168784624149040e+00,
               -1.25431509492537563e+00, 6.11238284081181527e-01},
              {8.53502683909504567e-01, -2.65167321543624879e-01,
               4.48574921439721497e-01, -4.36579217963183885e-01,
               -8.33857326820252154e-01, 3.37758116039923006e-01,
               2.84485069910403510e-01, -4.84115946952342446e-01,
               -8.27466008307597978e-01, 2.41345796944173463e+00,
               -1.41332447304637521e+00, 1.05687320725608180e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {4.58611603481254182e-01, 3.49381977667536647e-01,
               8.17072598263749006e-01, 6.80535447639515789e-01,
               -7.29353983011390206e-01, -7.01018685307663869e-02,
               5.71442824487661927e-01, 5.88196396747329486e-01,
               -5.72257020223449597e-01, 5.75633807507807127e-02,
               -4.37225066472288981e-01, 3.60163630658440592e-01},
              {3.22314930736028460e-01, -4.78022441514156737e-01,
               -8.17072598263749006e-01, 8.78520030779581518e-01,
               4.72533896718043356e-01, 7.01018685307663869e-02,
               3.52584232409324239e-01, -7.40409523075781451e-01,
               5.72257020223449597e-01, 5.16174984232034895e-01,
               2.43310381167226808e-01, 9.31606455146102519e-01},
              {3.22314930736028460e-01, 4.78022441514156737e-01,
               8.17072598263749006e-01, 8.78520030779581518e-01,
               -4.72533896718043356e-01, -7.01018685307663869e-02,
               3.52584232409324239e-01, 7.40409523075781451e-01,
               -5.72257020223449597e-01, 7.96932530300126230e-01,
               1.16291064418935552e+00, 1.21982240546222531e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {8.93043141740470170e-01, -3.87290716366134380e-01,
               -2.29084805272887743e-01, -3.93968212811596163e-01,
               -9.18952250678198412e-01, 1.77709951187529115e-02,
               -2.17400538831777873e-01, 7.43818660029464396e-02,
               -9.73244236420423237e-01, -8.60239069558661584e-01,
               5.59744534415890893e-01, -2.28001013891047655e-01},
              {9.17206259481271324e-01, 3.25964460580379423e-01,
               2.29084805272887743e-01, -3.30873201606983525e-01,
               9.43507878181647053e-01, -1.77709951187529115e-02,
               -2.21936031384538934e-01, -5.94983550000214578e-02,
               9.73244236420423237e-01, 3.28040721818085856e-02,
               1.65776321604294730e-01, -4.45401552722825556e-01},
              {9.17206259481271324e-01, -3.25964460580379423e-01,
               -2.29084805272887743e-01, -3.30873201606983525e-01,
               -9.43507878181647053e-01, 1.77709951187529115e-02,
               -2.21936031384538934e-01, 5.94983550000214578e-02,
               -9.73244236420423237e-01, 9.94809232017118794e-01,
               -3.54259479549068057e-02, -6.75514735911365904e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {6.40699663366035121e-01, 6.82472811622294118e-01,
               -3.51759580905779967e-01, 6.50125303664986776e-02,
               4.08276694492814674e-01, 9.10540230648468452e-01,
               7.65034190254262003e-01, -6.06251599693049537e-01,
               2.17213456331839749e-01, 2.31820758861717602e-01,
               -8.16282505034648942e-02, 3.36606215403507436e-01},
              {3.00625661628537044e-01, -8.86504037673486511e-01,
               3.51759580905779967e-01, -1.09867238199176723e-01,
               -3.98554486038131761e-01, -9.10540230648468452e-01,
               9.47392949910906612e-01, 2.35084905613878681e-01,
               -2.17213456331839749e-01, 8.72520422227752723e-01,
               -1.66157201369662166e-02, 1.10164040565776933e+00},
              {3.00625661628537044e-01, 8.86504037673486511e-01,
               -3.51759580905779967e-01, -1.09867238199176723e-01,
               3.98554486038131761e-01, 9.10540230648468452e-01,
               9.47392949910906612e-01, -2.35084905613878681e-01,
               2.17213456331839749e-01, 8.52980274960614904e-01,
               -2.70423102981481589e-01, 2.13393556217628166e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {5.75051372737690247e-01, 5.85953754504857205e-01,
               5.70941429828104030e-01, 4.32409434796270531e-01,
               3.74741021617637227e-01, -8.20116605987306957e-01,
               -6.94505579107661419e-01, 7.18489641051721306e-01,
               -3.78765928998512358e-02, -9.08524475691667499e-01,
               -5.16195579802288584e-01, 6.92693304151742240e-01},
              {1.63353787415506102e-01, -8.04575306508253485e-01,
               -5.70941429828104030e-01, 1.58692884205068191e-01,
               -5.49750235185522573e-01, 8.20116605987306957e-01,
               -9.73720754959904733e-01, -2.24573495921964239e-01,
               3.78765928998512358e-02, -3.33473102953977252e-01,
               -8.37861450060180535e-02, -1.81227495591917975e-03},
              {1.63353787415506102e-01, 8.04575306508253485e-01,
               5.70941429828104030e-01, 1.58692884205068191e-01,
               5.49750235185522573e-01, -8.20116605987306957e-01,
               -9.73720754959904733e-01, 2.24573495921964239e-01,
               -3.78765928998512358e-02, -6.37600314637612797e-01,
               -2.44513689343371005e-01, -1.10601657992732294e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-8.29613671938219222e-01, 3.94214664687267291e-01,
               -3.95393416079087845e-01, -5.49607619091530664e-01,
               -7.01330698253671114e-01, 4.53945720018987919e-01,
               -9.83494807801454929e-02, 5.93910809661285621e-01,
               7.98496919090958102e-01, 1.56747011660451685e-01,
               9.55395164955757714e-01, 5.53785534603690621e-01},
              {-8.73833152222204701e-01, -2.82983512945038873e-01,
               3.95393416079087845e-01, -4.53739004253362721e-01,
               7.66846920379556485e-01, -4.53945720018987919e-01,
               -1.74747068921262794e-01, -5.76078234362031316e-01,
               -7.98496919090958102e-01, -6.72866660277767537e-01,
               4.05787545864227051e-01, 4.55436053823545128e-01},
              {-8.73833152222204701e-01, 2.82983512945038873e-01,
               -3.95393416079087845e-01, -4.53739004253362721e-01,
               -7.66846920379556485e-01, 4.53945720018987919e-01,
               -1.74747068921262794e-01, 5.76078234362031316e-01,
               7.98496919090958102e-01, -1.76443023916242514e+00,
               5.42068452740658513e-01, -1.62551536261784868e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {3.03241433236194347e-02, 7.80783319580568791e-01,
               6.24065584851813515e-01, 2.17019804287030160e-01,
               6.04315760982818362e-01, -7.66619113755309556e-01,
               -9.75696085304695648e-01, 1.58681658966953798e-01,
               -1.51120085457187692e-01, 3.98104690444645026e-02,
               -4.65483297350445024e-01, 6.58144688147516810e-01},
              {-4.93880595862133009e-01, -6.05494923871727098e-01,
               -6.24065584851813515e-01, -2.37133849177191297e-01,
               -5.96709872550666653e-01, 7.66619113755309556e-01,
               -8.36570077522065025e-01, 5.26605378975698146e-01,
               1.51120085457187692e-01, 7.01346123680839373e-02,
               -2.48463493063414864e-01, -3.17551397157178839e-01},
              {-4.93880595862133009e-01, 6.05494923871727098e-01,
               6.24065584851813515e-01, -2.37133849177191297e-01,
               5.96709872550666653e-01, -7.66619113755309556e-01,
               -8.36570077522065025e-01, -5.26605378975698146e-01,
               -1.51120085457187692e-01, -8.25703317006256432e-01,
               -8.81722726277165303e-01, -8.04534904088770153e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {-8.41004288844043657e-01, 4.50287579979288366e-01,
               2.99921458822673292e-01, -2.19535093811559084e-01,
               -7.90687173296539036e-01, 5.71505150081325963e-01,
               4.94485721463294059e-01, 4.14794996716118747e-01,
               7.63825229989295806e-01, 2.02492311681404136e-01,
               5.49625216084595802e-01, -9.48454302033222785e-01},
              {-9.14589632350564008e-01, 2.71243291040607237e-01,
               -2.99921458822673292e-01, 3.99923492288942195e-01,
               7.16549414727231215e-01, -5.71505150081325963e-01,
               5.98916080288088293e-02, -6.42638322324091460e-01,
               -7.63825229989295806e-01, -6.38511977162639521e-01,
               3.30090122273036690e-01, -4.53968580569928726e-01},
              {-9.14589632350564008e-01, -2.71243291040607237e-01,
               2.99921458822673292e-01, 3.99923492288942195e-01,
               -7.16549414727231215e-01, 5.71505150081325963e-01,
               5.98916080288088293e-02, 6.42638322324091460e-01,
               7.63825229989295806e-01, -1.54270155992975821e+00,
               7.57487656089650074e-01, -4.18717104250007133e-01},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }},
          {{
              {3.77482434151088730e-01, -3.06599462183628546e-01,
               8.73787034520471129e-01, -1.04989304171713344e-01,
               -9.51683315685895925e-01, -2.88576008452953503e-01,
               9.20045791206561936e-01, 1.71940813598569220e-02,
               -3.91433398740171690e-01, 8.76016432804421097e-01,
               5.80071929854323320e-01, 9.14407532663196188e-01},
              {4.81564879057004958e-01, 6.77605014941116968e-02,
               -8.73787034520471129e-01, 4.01295105652294759e-01,
               8.69302091062062798e-01, 2.88576008452953503e-01,
               7.79138951303505189e-01, -4.89614530944897430e-01,
               3.91433398740171690e-01, 1.25349886695550983e+00,
               4.75082625682609949e-01, 1.83445332386975801e+00},
              {4.81564879057004958e-01, -6.77605014941116968e-02,
               8.73787034520471129e-01, 4.01295105652294759e-01,
               -8.69302091062062798e-01, -2.88576008452953503e-01,
               7.79138951303505189e-01, 4.89614530944897430e-01,
               -3.91433398740171690e-01, 1.78743697517826994e+00,
               1.54827591133022069e+00, 2.23516098457413559e+00},
              {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
          }}};
}

template <>
std::vector<OutputTestData<float>> GetOutputTestData() {
  return {
      {{
          {6.41276836395263672e-02, 7.93746292591094971e-01,
           6.04859292507171631e-01, 9.90459501743316650e-01,
           -1.24706387519836426e-01, 5.86402416229248047e-02,
           1.21975198388099670e-01, 5.95328032970428467e-01,
           -7.94170737266540527e-01, -7.69890904426574707e-01,
           -6.27744197845458984e-03, 2.18133091926574707e-01},
          {-1.26849487423896790e-01, -7.86164641380310059e-01,
           -6.04859292507171631e-01, 9.91646409034729004e-01,
           -1.14887490868568420e-01, -5.86402416229248047e-02,
           -2.33899354934692383e-02, -6.07244908809661865e-01,
           7.94170737266540527e-01, -7.05763220787048340e-01,
           9.84182059764862061e-01, 3.40108275413513184e-01},
          {-1.26849487423896790e-01, 7.86164641380310059e-01,
           6.04859292507171631e-01, 9.91646409034729004e-01,
           1.14887490868568420e-01, 5.86402416229248047e-02,
           -2.33899354934692383e-02, 6.07244908809661865e-01,
           -7.94170737266540527e-01, -1.48345279693603516e+00,
           1.88071680068969727e+00, -1.85999929904937744e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {5.19892215728759766e-01, 7.64537453651428223e-01,
           -3.81044179201126099e-01, 8.44718098640441895e-01,
           -3.93733263015747070e-01, 3.62526893615722656e-01,
           1.27135604619979858e-01, -5.10349810123443604e-01,
           -8.50517511367797852e-01, -3.45721900463104248e-01,
           6.22072815895080566e-01, 7.18274950981140137e-01},
          {5.17670214176177979e-02, -9.23106491565704346e-01,
           3.81044179201126099e-01, 9.26841616630554199e-01,
           -9.76687967777252197e-02, -3.62526893615722656e-01,
           3.71867030858993530e-01, 3.71934533119201660e-01,
           8.50517511367797852e-01, 1.74170315265655518e-01,
           1.46679091453552246e+00, 8.45410585403442383e-01},
          {5.17670214176177979e-02, 9.23106491565704346e-01,
           -3.81044179201126099e-01, 9.26841616630554199e-01,
           9.76687967777252197e-02, 3.62526893615722656e-01,
           3.71867030858993530e-01, -3.71934533119201660e-01,
           -8.50517511367797852e-01, -1.32106006145477295e-01,
           2.35575008392333984e+00, 1.36153912544250488e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-2.55427956581115723e-01, -9.66738581657409668e-01,
           1.31658315658569336e-02, -4.85187530517578125e-01,
           1.16391777992248535e-01, -8.66629242897033691e-01,
           8.36271405220031738e-01, -2.27749139070510864e-01,
           -4.98779296875000000e-01, -9.41972374916076660e-01,
           1.89657092094421387e-01, 4.67496633529663086e-01},
          {5.17290234565734863e-01, 8.55708897113800049e-01,
           -1.31658315658569336e-02, -4.20980393886566162e-01,
           2.67823666334152222e-01, 8.66629242897033691e-01,
           7.45108306407928467e-01, -4.42756295204162598e-01,
           4.98779296875000000e-01, -1.19740033149719238e+00,
           -2.95530438423156738e-01, 1.30376803874969482e+00},
          {5.17290234565734863e-01, -8.55708897113800049e-01,
           1.31658315658569336e-02, -4.20980393886566162e-01,
           -2.67823666334152222e-01, -8.66629242897033691e-01,
           7.45108306407928467e-01, 4.42756295204162598e-01,
           -4.98779296875000000e-01, 1.65941238403320312e-01,
           -4.51709836721420288e-01, 1.61111700534820557e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {7.34392702579498291e-01, -6.60752713680267334e-01,
           -1.55155330896377563e-01, 5.70733845233917236e-01,
           7.24910736083984375e-01, -3.85703742504119873e-01,
           3.67328554391860962e-01, 1.94705620408058167e-01,
           9.09483075141906738e-01, -4.91157770156860352e-01,
           -6.37698769569396973e-02, -8.86230111122131348e-01},
          {8.61385941505432129e-01, 4.83674526214599609e-01,
           1.55155330896377563e-01, 3.97924363613128662e-01,
           -8.32399487495422363e-01, 3.85703742504119873e-01,
           3.15706282854080200e-01, -2.70499706268310547e-01,
           -9.09483075141906738e-01, 2.43234932422637939e-01,
           5.06963968276977539e-01, -5.18901586532592773e-01},
          {8.61385941505432129e-01, -4.83674526214599609e-01,
           -1.55155330896377563e-01, 3.97924363613128662e-01,
           8.32399487495422363e-01, -3.85703742504119873e-01,
           3.15706282854080200e-01, 2.70499706268310547e-01,
           9.09483075141906738e-01, 1.27404165267944336e+00,
           6.13316833972930908e-01, -2.97945499420166016e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-3.91394257545471191e-01, 8.29543650150299072e-01,
           -3.98331522941589355e-01, 5.35353124141693115e-01,
           5.57334721088409424e-01, 6.34645640850067139e-01,
           7.48470187187194824e-01, 3.51486206054687500e-02,
           -6.62236332893371582e-01, -1.90021097660064697e-01,
           1.61754488945007324e-01, -3.67807030677795410e-01},
          {-8.79796147346496582e-01, -2.59404748678207397e-01,
           3.98331522941589355e-01, -6.01719617843627930e-02,
           -7.70457148551940918e-01, -6.34645640850067139e-01,
           4.71527457237243652e-01, -5.82327127456665039e-01,
           6.62236332893371582e-01, -5.81415355205535889e-01,
           6.97107613086700439e-01, 3.80663156509399414e-01},
          {-8.79796147346496582e-01, 2.59404748678207397e-01,
           -3.98331522941589355e-01, -6.01719617843627930e-02,
           7.70457148551940918e-01, 6.34645640850067139e-01,
           4.71527457237243652e-01, 5.82327127456665039e-01,
           -6.62236332893371582e-01, -1.55122351646423340e+00,
           3.69591385126113892e-01, 6.50126397609710693e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-8.37893486022949219e-02, -1.87446445226669312e-01,
           -9.78694558143615723e-01, -9.94889378547668457e-01,
           7.12673664093017578e-02, 7.15262889862060547e-02,
           5.63416182994842529e-02, 9.79686021804809570e-01,
           -1.92459821701049805e-01, 6.97878241539001465e-01,
           2.41143226623535156e-01, 9.42930221557617188e-01},
          {1.04527190327644348e-01, 1.76722630858421326e-01,
           9.78694558143615723e-01, -6.33227944374084473e-01,
           7.70653128623962402e-01, -7.15262889862060547e-02,
           -7.66874372959136963e-01, -6.12260282039642334e-01,
           1.92459821701049805e-01, 6.14088892936706543e-01,
           -7.53746151924133301e-01, 9.99271869659423828e-01},
          {1.04527190327644348e-01, -1.76722630858421326e-01,
           -9.78694558143615723e-01, -6.33227944374084473e-01,
           -7.70653128623962402e-01, 7.15262889862060547e-02,
           -7.66874372959136963e-01, 6.12260282039642334e-01,
           -1.92459821701049805e-01, 7.97246217727661133e-01,
           -1.04408335685729980e+00, -4.00186777114868164e-02},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-5.73339223861694336e-01, 7.06170260906219482e-01,
           4.15458440780639648e-01, 7.74836361408233643e-01,
           3.02524209022521973e-01, 5.55074572563171387e-01,
           2.66290903091430664e-01, 6.40158295631408691e-01,
           -7.20615386962890625e-01, -1.08483254909515381e-01,
           -1.42177522182464600e-01, 3.39449286460876465e-01},
          {-9.09581184387207031e-01, 7.51054286956787109e-03,
           -4.15458440780639648e-01, 2.46976226568222046e-01,
           -7.94288992881774902e-01, -5.55074572563171387e-01,
           -3.34162950515747070e-01, -6.07493698596954346e-01,
           7.20615386962890625e-01, -6.81822478771209717e-01,
           6.32658839225769043e-01, 6.05740189552307129e-01},
          {-9.09581184387207031e-01, -7.51054286956787109e-03,
           4.15458440780639648e-01, 2.46976226568222046e-01,
           7.94288992881774902e-01, 5.55074572563171387e-01,
           -3.34162950515747070e-01, 6.07493698596954346e-01,
           -7.20615386962890625e-01, -1.58537387847900391e+00,
           2.41938441991806030e-01, -2.16150403022766113e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-4.84365701675415039e-01, 3.21124136447906494e-01,
           -8.13799262046813965e-01, -2.35107839107513428e-01,
           8.48202347755432129e-01, 4.74633574485778809e-01,
           8.42682719230651855e-01, 4.21226799488067627e-01,
           -3.35341334342956543e-01, -4.03993010520935059e-01,
           5.96984386444091797e-01, -4.75390374660491943e-01},
          {-5.80627679824829102e-01, -2.45417952537536621e-02,
           8.13799262046813965e-01, -6.39684855937957764e-01,
           -6.04587674140930176e-01, -4.74633574485778809e-01,
           5.03661274909973145e-01, -7.96160459518432617e-01,
           3.35341334342956543e-01, -8.88358712196350098e-01,
           3.61876547336578369e-01, 3.67292344570159912e-01},
          {-5.80627679824829102e-01, 2.45417952537536621e-02,
           -8.13799262046813965e-01, -6.39684855937957764e-01,
           6.04587674140930176e-01, 4.74633574485778809e-01,
           5.03661274909973145e-01, 7.96160459518432617e-01,
           -3.35341334342956543e-01, -1.48261141777038574e+00,
           -6.13462507724761963e-01, 4.28942322731018066e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-7.62338280677795410e-01, -6.98405653238296509e-02,
           -6.43399536609649658e-01, -3.83135378360748291e-01,
           8.49928617477416992e-01, 3.61702531576156616e-01,
           5.21582186222076416e-01, 5.22248744964599609e-01,
           -6.74691557884216309e-01, -4.88072633743286133e-02,
           6.49535417556762695e-01, 2.72747397422790527e-01},
          {-4.13604319095611572e-01, 6.44180774688720703e-01,
           6.43399536609649658e-01, -9.05875682830810547e-01,
           -2.20364838838577271e-01, -3.61702531576156616e-01,
           -9.12190973758697510e-02, -7.32441663742065430e-01,
           6.74691557884216309e-01, -8.11145544052124023e-01,
           2.66400039196014404e-01, 7.94329583644866943e-01},
          {-4.13604319095611572e-01, -6.44180774688720703e-01,
           -6.43399536609649658e-01, -9.05875682830810547e-01,
           2.20364838838577271e-01, 3.61702531576156616e-01,
           -9.12190973758697510e-02, 7.32441663742065430e-01,
           -6.74691557884216309e-01, -1.14377808570861816e+00,
           -6.67174875736236572e-01, 6.11044645309448242e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {1.19545459747314453e-02, -5.94622611999511719e-01,
           8.03916215896606445e-01, 9.90230083465576172e-01,
           1.18744730949401855e-01, 7.31051862239837646e-02,
           -1.38930916786193848e-01, 7.95187950134277344e-01,
           5.90232491493225098e-01, 8.20306181907653809e-01,
           9.26848888397216797e-01, 5.05113601684570312e-02},
          {1.18749484419822693e-01, 5.82767128944396973e-01,
           -8.03916215896606445e-01, 9.52703416347503662e-01,
           -2.94978201389312744e-01, -7.31051862239837646e-02,
           -2.79741108417510986e-01, -7.57212340831756592e-01,
           -5.90232491493225098e-01, 8.32260727882385254e-01,
           1.91707897186279297e+00, -8.84195566177368164e-02},
          {1.18749484419822693e-01, -5.82767128944396973e-01,
           8.03916215896606445e-01, 9.52703416347503662e-01,
           2.94978201389312744e-01, 7.31051862239837646e-02,
           -2.79741108417510986e-01, 7.57212340831756592e-01,
           5.90232491493225098e-01, 9.87401068210601807e-01,
           2.85136246681213379e+00, -4.15444731712341309e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {1.60408377647399902e-01, -9.86328363418579102e-01,
           -3.77551317214965820e-02, -5.95103502273559570e-02,
           2.85167694091796875e-02, -9.97820258140563965e-01,
           9.85255122184753418e-01, 1.62305474281311035e-01,
           -5.41224479675292969e-02, 9.06080484390258789e-01,
           -6.93083226680755615e-01, -1.76094055175781250e-01},
          {7.39692270755767822e-01, 6.71885311603546143e-01,
           3.77551317214965820e-02, -6.43220692873001099e-02,
           1.47431120276451111e-02, 9.97820258140563965e-01,
           6.69864237308502197e-01, -7.40508437156677246e-01,
           5.41224479675292969e-02, 1.06648886203765869e+00,
           -7.52593576908111572e-01, 8.09161067008972168e-01},
          {7.39692270755767822e-01, -6.71885311603546143e-01,
           -3.77551317214965820e-02, -6.43220692873001099e-02,
           -1.47431120276451111e-02, -9.97820258140563965e-01,
           6.69864237308502197e-01, 7.40508437156677246e-01,
           -5.41224479675292969e-02, 2.30034375190734863e+00,
           -8.06072294712066650e-01, 9.34391260147094727e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-1.33050441741943359e-01, -9.90395009517669678e-01,
           3.76191586256027222e-02, 8.59984695911407471e-01,
           -9.64967012405395508e-02, 5.01113355159759521e-01,
           -4.92670059204101562e-01, 9.90252345800399780e-02,
           8.64563584327697754e-01, 2.57571578025817871e-01,
           8.43950867652893066e-01, -4.48882460594177246e-01},
          {7.32324719429016113e-02, 9.96605157852172852e-01,
           -3.76191586256027222e-02, 8.61467123031616211e-01,
           -8.22179764509201050e-02, -5.01113355159759521e-01,
           -5.02505123615264893e-01, 4.29013371467590332e-03,
           -8.64563584327697754e-01, 1.24521136283874512e-01,
           1.70393562316894531e+00, -9.41552519798278809e-01},
          {7.32324719429016113e-02, -9.96605157852172852e-01,
           3.76191586256027222e-02, 8.61467123031616211e-01,
           8.22179764509201050e-02, 5.01113355159759521e-01,
           -5.02505123615264893e-01, -4.29013371467590332e-03,
           8.64563584327697754e-01, 3.92579197883605957e-01,
           2.54932999610900879e+00, -1.44321894645690918e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {6.27079010009765625e-02, 4.37803626060485840e-01,
           -8.96881163120269775e-01, -2.70977556705474854e-01,
           -8.57423305511474609e-01, -4.37488794326782227e-01,
           -9.60540950298309326e-01, 2.70468652248382568e-01,
           6.48677349090576172e-02, -1.91189527511596680e-01,
           8.33737850189208984e-01, 9.87144947052001953e-01},
          {-1.31881117820739746e-01, -4.22151237726211548e-01,
           8.96881163120269775e-01, 1.24552085995674133e-01,
           8.90556216239929199e-01, 4.37488794326782227e-01,
           -9.83409464359283447e-01, 1.69404923915863037e-01,
           -6.48677349090576172e-02, -1.28481626510620117e-01,
           5.62760293483734131e-01, 2.66039967536926270e-02},
          {-1.31881117820739746e-01, 4.22151237726211548e-01,
           -8.96881163120269775e-01, 1.24552085995674133e-01,
           -8.90556216239929199e-01, -4.37488794326782227e-01,
           -9.83409464359283447e-01, -1.69404923915863037e-01,
           6.48677349090576172e-02, -4.27181690931320190e-01,
           1.03922808170318604e+00, -8.89862716197967529e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {8.55602860450744629e-01, -9.35635715723037720e-02,
           5.09106755256652832e-01, 4.51308548450469971e-01,
           -3.46834063529968262e-01, -8.22208642959594727e-01,
           2.53504246473312378e-01, 9.33248281478881836e-01,
           -2.54526138305664062e-01, 1.21326327323913574e-01,
           5.52034258842468262e-01, -1.77489042282104492e-01},
          {8.24695885181427002e-01, -2.46347472071647644e-01,
           -5.09106755256652832e-01, 5.50630629062652588e-01,
           1.44149750471115112e-01, 8.22208642959594727e-01,
           -1.29161491990089417e-01, -9.58401858806610107e-01,
           2.54526138305664062e-01, 9.76929187774658203e-01,
           1.00334286689758301e+00, 7.60152041912078857e-02},
          {8.24695885181427002e-01, 2.46347472071647644e-01,
           5.09106755256652832e-01, 5.50630629062652588e-01,
           -1.44149750471115112e-01, -8.22208642959594727e-01,
           -1.29161491990089417e-01, 9.58401858806610107e-01,
           -2.54526138305664062e-01, 1.56777238845825195e+00,
           1.69081187248229980e+00, -9.62937831878662109e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {7.32641577720642090e-01, 2.16403350234031677e-01,
           -6.45295143127441406e-01, 2.23454937338829041e-01,
           8.19072723388671875e-01, 5.28382182121276855e-01,
           6.42887353897094727e-01, -5.31309127807617188e-01,
           5.51730394363403320e-01, 3.40290307998657227e-01,
           -1.26920998096466064e-01, 4.09431219100952148e-01},
          {5.17112910747528076e-01, -5.62306284904479980e-01,
           6.45295143127441406e-01, -2.29483723640441895e-01,
           -8.17404091358184814e-01, -5.28382182121276855e-01,
           8.24579477310180664e-01, 1.25148475170135498e-01,
           -5.51730394363403320e-01, 1.07293188571929932e+00,
           9.65339392423629761e-02, 1.05231857299804688e+00},
          {5.17112910747528076e-01, 5.62306284904479980e-01,
           -6.45295143127441406e-01, -2.29483723640441895e-01,
           8.17404091358184814e-01, 5.28382182121276855e-01,
           8.24579477310180664e-01, -1.25148475170135498e-01,
           5.51730394363403320e-01, 1.49116849899291992e+00,
           -2.76682734489440918e-01, 1.89890432357788086e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {9.63335573673248291e-01, -2.45017558336257935e-01,
           -1.09320744872093201e-01, 1.33488237857818604e-01,
           7.91148424148559570e-01, -5.96879541873931885e-01,
           2.32734873890876770e-01, 5.60402214527130127e-01,
           7.94848322868347168e-01, -5.87836265563964844e-01,
           6.23236179351806641e-01, -6.01677060127258301e-01},
          {9.93160128593444824e-01, -4.10118550062179565e-02,
           1.09320744872093201e-01, -9.85813289880752563e-02,
           -7.96251654624938965e-01, 5.96879541873931885e-01,
           6.25676661729812622e-02, -6.03573858737945557e-01,
           -7.94848322868347168e-01, 3.75499308109283447e-01,
           7.56724417209625244e-01, -3.68942201137542725e-01},
          {9.93160128593444824e-01, 4.10118550062179565e-02,
           -1.09320744872093201e-01, -9.85813289880752563e-02,
           7.96251654624938965e-01, -5.96879541873931885e-01,
           6.25676661729812622e-02, 6.03573858737945557e-01,
           7.94848322868347168e-01, 1.36030614376068115e+00,
           4.95962440967559814e-01, -4.29310560226440430e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-7.03748226165771484e-01, -4.89697754383087158e-01,
           -5.14718234539031982e-01, 6.45890533924102783e-01,
           -7.42762207984924316e-01, -1.76436960697174072e-01,
           -2.95912414789199829e-01, -4.56618785858154297e-01,
           8.39008450508117676e-01, 3.11925649642944336e-01,
           -1.94054305553436279e-01, -4.00766432285308838e-01},
          {-4.54625189304351807e-01, 7.26898431777954102e-01,
           5.14718234539031982e-01, 8.85854601860046387e-01,
           4.29106026887893677e-01, 1.76436960697174072e-01,
           -9.26169008016586304e-02, 5.36178112030029297e-01,
           -8.39008450508117676e-01, -3.91822576522827148e-01,
           4.51836228370666504e-01, -6.96678876876831055e-01},
          {-4.54625189304351807e-01, -7.26898431777954102e-01,
           -5.14718234539031982e-01, 8.85854601860046387e-01,
           -4.29106026887893677e-01, -1.76436960697174072e-01,
           -9.26169008016586304e-02, -5.36178112030029297e-01,
           8.39008450508117676e-01, -1.57763302326202393e-01,
           1.74423825740814209e+00, -2.81305253505706787e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {3.83620619773864746e-01, 7.82426118850708008e-01,
           4.90555375814437866e-01, -3.26156973838806152e-01,
           6.11755132675170898e-01, -7.20678329467773438e-01,
           -8.63977313041687012e-01, 1.16468995809555054e-01,
           4.89875555038452148e-01, -3.79460930824279785e-01,
           9.21431660652160645e-01, -5.13203978538513184e-01},
          {1.82089775800704956e-01, -8.52172970771789551e-01,
           -4.90555375814437866e-01, -4.64978694915771484e-01,
           -5.14215469360351562e-01, 7.20678329467773438e-01,
           -8.66393744945526123e-01, 9.68696475028991699e-02,
           -4.89875555038452148e-01, 4.15968894958496094e-03,
           5.95274686813354492e-01, -1.37718129158020020e+00},
          {1.82089775800704956e-01, 8.52172970771789551e-01,
           4.90555375814437866e-01, -4.64978694915771484e-01,
           5.14215469360351562e-01, -7.20678329467773438e-01,
           -8.66393744945526123e-01, -9.68696475028991699e-02,
           4.89875555038452148e-01, 1.80174663662910461e-01,
           1.26630365848541260e-01, -2.24288463592529297e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {6.50896191596984863e-01, 7.57031917572021484e-01,
           5.68940937519073486e-02, -6.32351160049438477e-01,
           4.99172985553741455e-01, 5.92417478561401367e-01,
           4.20078873634338379e-01, -4.21579360961914062e-01,
           8.03619742393493652e-01, 4.95541214942932129e-01,
           1.60016179084777832e-01, 4.40293312072753906e-01},
          {5.69820940494537354e-01, -8.19797039031982422e-01,
           -5.68940937519073486e-02, -6.80212736129760742e-01,
           -4.31685358285903931e-01, -5.92417478561401367e-01,
           4.61101710796356201e-01, 3.76272022724151611e-01,
           -8.03619742393493652e-01, 1.14643740653991699e+00,
           -4.72334980964660645e-01, 8.60372185707092285e-01},
          {5.69820940494537354e-01, 8.19797039031982422e-01,
           5.68940937519073486e-02, -6.80212736129760742e-01,
           4.31685358285903931e-01, 5.92417478561401367e-01,
           4.61101710796356201e-01, -3.76272022724151611e-01,
           8.03619742393493652e-01, 1.14937162399291992e+00,
           -1.45105659961700439e+00, 1.58166468143463135e+00},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
      {{
          {-1.13169431686401367e-01, -9.92323219776153564e-01,
           4.98764514923095703e-02, 8.76565873622894287e-01,
           -7.60816335678100586e-02, 4.75230723619461060e-01,
           -4.67787742614746094e-01, 9.75014865398406982e-02,
           8.78446459770202637e-01, 8.87284874916076660e-01,
           5.10597467422485352e-01, 6.67929649353027344e-03},
          {8.48174765706062317e-02, 9.95147585868835449e-01,
           -4.98764514923095703e-02, 8.74348521232604980e-01,
           -9.83401164412498474e-02, -4.75230723619461060e-01,
           -4.77829486131668091e-01, -3.30144912004470825e-03,
           -8.78446459770202637e-01, 7.74115443229675293e-01,
           1.38716340065002441e+00, -4.61108446121215820e-01},
          {8.48174765706062317e-02, -9.95147585868835449e-01,
           4.98764514923095703e-02, 8.74348521232604980e-01,
           9.83401164412498474e-02, 4.75230723619461060e-01,
           -4.77829486131668091e-01, 3.30144912004470825e-03,
           8.78446459770202637e-01, 9.42978501319885254e-01,
           2.25320649147033691e+00, -9.39216732978820801e-01},
          {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
      }},
  };
}

template <typename T>
class AssemblyKinematicsTest : public ::testing::Test {
 public:
};

TYPED_TEST_SUITE_P(AssemblyKinematicsTest);

TYPED_TEST_P(AssemblyKinematicsTest, ComputePosesIsConsistentWithGoldenData) {
  using Scalar = TypeParam;
  // An assembly with some branching, rotational, fixed and rotational links.
  const auto proto = ParseTextProtoOrDie<proto::Assembly>(
      R"pb(
        joints: {
          name: "revolute_joint"
          parent_link_name: "root"
          child_link_name: "link_1"
          parent_t_joint: { tx: 1 ty: 0 tz: 0 rx: 1 ry: 0 rz: 0 rw: 0 }
          axis: { vec: 0 vec: 0 vec: 1 }
          type: REVOLUTE
        }
        joints: {
          name: "fixed_joint"
          parent_link_name: "link_1"
          child_link_name: "empty_leaf"
          parent_t_joint: { tx: 1 ty: 0 tz: 0 rx: 0 ry: 1 rz: 0 rw: 0 }
          type: FIXED
        }
        joints: {
          name: "prismatic_joint"
          parent_link_name: "link_1"
          child_link_name: "link_2"
          parent_t_joint: { tx: 1 ty: 1 tz: 0 rx: 1 ry: 0 rz: 0 rw: 0 }
          axis: { vec: 0 vec: 1 vec: 0 }
          type: PRISMATIC
        }
        links: { name: "root" }
        links: { name: "empty_leaf" }
        links: { name: "link_1" }
        links: {
          name: "link_2"
          # Add collision bodies FK is computed for the leaf node.
          collision_shapes: {
            primitive { sphere { radius: 0.1 } }
            link_t_shape { tx: 0.0 ty: 0.0 tz: 0.0 rx: 0 ry: 0 rz: 0 rw: 1 }
          }
        }
      )pb");

  CC_ASSERT_OK_AND_ASSIGN(Assembly assembly, FromProto(proto));
  const std::vector<std::string> joint_order = {"revolute_joint",
                                                "prismatic_joint"};
  CC_ASSERT_OK_AND_ASSIGN(
      auto kinematics,
      AssemblyKinematics<Scalar>::CreateForAssembly(assembly, joint_order));

  AssemblyPoses<Scalar> poses(kinematics.links.size());
  AssemblyCoordinates<Scalar> coordinates(joint_order.size());
  auto coordinate_view = coordinates.View();

  // Generators for quasi-random test data.
  const auto input_data = GetInputTestData<Scalar>();
  const auto output_data = GetOutputTestData<Scalar>();
  ASSERT_EQ(input_data.size(), output_data.size());

  for (int p = 0; p < poses.GetPoseCount(); ++p) {
    poses.odom_rotation_link[p].setZero();
    poses.odom_translation_link[p].setZero();
  }

  const Scalar kGoldenEpsilon = std::numeric_limits<Scalar>::epsilon();
  for (int loop = 0; loop < input_data.size(); ++loop) {
    SCOPED_TRACE(::testing::Message() << "loop= " << loop);
    const Scalar* inputs = input_data[loop].values;
    coordinate_view.odom_quaternion_root =
        Quaternion<Scalar>(inputs[0], inputs[1], inputs[2], inputs[3]);
    coordinate_view.odom_translation_root =
        Vector3<Scalar>(inputs[4], inputs[5], inputs[6]);
    coordinate_view.joint_positions = Vector2<Scalar>(inputs[7], inputs[8]);

    ComputePoses(kinematics, coordinates.ConstView(), poses.View());

    const OutputTestData<Scalar>& outputs = output_data[loop];
    for (int p = 0; p < poses.GetPoseCount(); ++p) {
      SCOPED_TRACE(::testing::Message() << "p= " << p);
      for (int i = 0; i < 3; ++i) {
        for (int j = 0; j < 3; ++j) {
          EXPECT_NEAR(poses.odom_rotation_link[p](i, j),
                      outputs.values[p][3 * i + j], kGoldenEpsilon)
              << "diff= "
              << poses.odom_rotation_link[p](i, j) -
                     outputs.values[p][3 * i + j]
              << ", i= " << i << " j= " << j;
        }
      }
      for (int i = 0; i < 3; ++i) {
        EXPECT_NEAR(poses.odom_translation_link[p](i), outputs.values[p][9 + i],
                    kGoldenEpsilon)
            << "diff= "
            << poses.odom_translation_link[p](i) - outputs.values[p][9 + i]
            << " i= " << i;
      }
    }
  }
}

REGISTER_TYPED_TEST_SUITE_P(AssemblyKinematicsTest,
                            ComputePosesIsConsistentWithGoldenData);

typedef ::testing::Types<float, double> FPTypes;

INSTANTIATE_TYPED_TEST_SUITE_P(AssemblyKinematicsTestSuite,
                               AssemblyKinematicsTest, FPTypes);
}  // namespace
}  // namespace collision_checking
